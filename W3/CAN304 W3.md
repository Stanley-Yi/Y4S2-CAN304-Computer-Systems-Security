# CAN304 W3

## Message authentication code

### Message integrity

æˆ‘ä»¬ä¸€ç›´å…³æ³¨ç¡®ä¿é€šä¿¡çš„ä¿å¯†æ€§ã€‚

Integrityï¼šç¡®ä¿æ¥æ”¶åˆ°çš„æ¶ˆæ¯æ¥è‡ªé¢„æœŸæ–¹ï¼Œå¹¶ä¸”æœªè¢«ä¿®æ”¹ï¼Œå³ä½¿æ”»å‡»è€…æ§åˆ¶è¯¥é€šé“ã€‚



ä¿å¯† (secrecy) å’Œå®Œæ•´æ€§ (integrity) æ˜¯æ­£äº¤çš„é—®é¢˜ï¼Œå¯ä»¥æœ‰ä¸€ä¸ªè€Œæ²¡æœ‰å¦ä¸€ä¸ªã€‚

åŠ å¯†å¯ä»¥å¸®åŠ©å‘ç°ä¿¡æ¯æ˜¯å¦è¢«æ›´æ”¹ï¼šå¦‚æœè§£å¯†çš„æ¶ˆæ¯æ¯«æ— æ„ä¹‰ï¼Œä¸å¯è¯»ï¼Œåˆ™è¢«æ›´æ”¹äº†ï¼›ä½†åŠ å¯†çš„ç›®çš„ä¸æ˜¯ã€‚



**Message authentication code (MAC)**

æ¶ˆæ¯èº«ä»½éªŒè¯ä»£ç ç”±ä¸‰ç§ç®—æ³•ï¼ˆGenã€Macã€Vrfyï¼‰å®šä¹‰ï¼š

* Genï¼šç”Ÿæˆä¸€ä¸ªéšæœºå¯†é’¥ k

* Macï¼šå°†å¯†é’¥ k å’Œ message $m  \in \{0, 1\}^*$ ä½œä¸ºè¾“å…¥ï¼Œè¾“å‡º tag t
  $$
  t:=Mac_k(m)
  $$
  
* Vrfyï¼šå°†å¯†é’¥ kã€message m å’Œ tag t ä½œä¸ºè¾“å…¥ï¼›è¾“å‡º 1ï¼ˆâ€œacceptâ€ï¼‰æˆ– 0ï¼ˆâ€œrejectâ€ï¼‰(å¦‚æœæ˜¯ Gan ç”Ÿæˆçš„å¯†é’¥ï¼Œåˆ™æ¥å—ï¼›å¦‚æœä¸æ˜¯ï¼Œåˆ™æ‹’ç»)
  $$
  For \ all \ m \ and \ all \ k \ output \ by \ Genknow \\
  Vrfy_k(m, Mac_k(m)) = 1
  $$

æœ€åéªŒè¯ä¸»è¦é  message m å’Œ tag tã€‚



### Fixed-length MAC

<img src="D:\Files\Learning Materials\Y4\Semester-2\CAN304\MD Picture\W3 Fixed-length MAC.png" alt="W3 Fixed-length MAC" style="zoom: 50%;" />

åœ¨å®è·µä¸­ï¼Œblock ciphers å…·æœ‰çŸ­çš„ï¼Œå›ºå®šé•¿åº¦å—å¤§å°ã€‚å› æ­¤ï¼Œä¹‹å‰çš„æ„é€ ä»…é™äºå¯¹çŸ­çš„ã€å›ºå®šé•¿åº¦çš„æ¶ˆæ¯è¿›è¡Œèº«ä»½éªŒè¯ã€‚



### CBC-MAC

**Recall CBC mode**

CBC ä½¿ç”¨å…ˆå‰å—çš„å¯†æ–‡æ¥åŠ å¯†å½“å‰å—ï¼šå°†å…ˆå‰å—çš„å¯†æ–‡å’Œå½“å‰å—çš„æ˜æ–‡è¿›è¡Œå¼‚æˆ–æ“ä½œï¼Œå†åŠ å¯†å…¶ç»“æœã€‚è¿™æ ·æ¯ä¸ªå—çš„åŠ å¯†å–å†³äºæ‰€æœ‰å…ˆå‰å—çš„å†…å®¹ã€‚

<img src="D:\Files\Learning Materials\Y4\Semester-2\CAN304\MD Picture\W2 CBC mode.png" alt="W2 CBC mode" style="zoom: 50%;" />



**CBC-MAC**

CBC-MAC ä½¿ç”¨ CBC modeï¼Œ$m = m_1m_2â€¦m_l$ã€‚

<img src="D:\Files\Learning Materials\Y4\Semester-2\CAN304\MD Picture\W3 CBC-MAC.png" alt="W3 CBC-MAC" style="zoom: 50%;" />

CBC-MAC ä¸»è¦ç”Ÿæˆ tag tï¼Œç”¨æ¥éªŒè¯ã€‚



**CBC-MAC vs. CBC-mode encryption**

* CBC-MAC æ˜¯ç¡®å®šæ€§çš„ (deterministicï¼Œæ²¡æœ‰ IVï¼Œinitialization vectors)ï¼Œå¯¹äºç›¸åŒçš„è¾“å…¥æ€»æ˜¯æœ‰ç›¸åŒçš„ç»“æœ

* åœ¨ CBC-MAC ä¸­ï¼Œä»…è¾“å‡ºæœ€ç»ˆå€¼ tï¼Œé€šè¿‡é‡æ–°è®¡ç®—ç»“æœè¿›è¡ŒéªŒè¯

  

* å¯ä»¥ä»å…¶ MAC çš„ tag ä¸­æ¢å¤åŸå§‹ message å—ï¼Ÿ
  * ä¸è¡Œï¼



**CBC-MAC extensions**

å¤„ç†å¯å˜é•¿åº¦æ¶ˆæ¯çš„å‡ ç§æ–¹æ³•

* å…¶é•¿åº¦ä¸æ˜¯å—é•¿åº¦çš„å€æ•°

æœ€ç®€å•çš„æ–¹æ³•ä¹‹ä¸€ï¼šåœ¨åº”ç”¨ CBC-MAC ä¹‹å‰é¢„ç½®æ¶ˆæ¯é•¿åº¦

<img src="D:\Files\Learning Materials\Y4\Semester-2\CAN304\MD Picture\W3 CBC-MAC extensions.png" alt="W3 CBC-MAC extensions" style="zoom:60%;" />

å‡å¦‚å—çš„é•¿åº¦ä¸º128 bitï¼Œæˆ‘ä»¬æŠŠæ¶ˆæ¯åˆ†æˆé•¿åº¦ä¸º 128 bit çš„å—ï¼Œç„¶ååˆ° m~1~ çš„æ—¶å€™ï¼Œå‘ç° m~1~ çš„é•¿åº¦ä¸è¶³ 128 bitã€‚æˆ‘ä»¬ä½¿ç”¨ l æŠŠ m~1~ çš„é•¿åº¦è¡¥æˆ 128 bitï¼Œå†è¿›è¡Œ CBC-MACã€‚ä¹‹åå‘é€æ–¹è¦æŠŠ l ä¹Ÿå‘Šè¯‰æ¥æ”¶æ–¹ï¼Œæ¥æ”¶æ–¹ä»¥ç›¸åŒçš„æ“ä½œæ¥è¿›è¡ŒéªŒè¯ã€‚



### Secure communications

åœ¨æ¶ˆæ¯ä¼ é€’ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›åŒæ—¶è¾¾åˆ° Secrecy å’Œ integrityã€‚æˆ‘ä»¬ç”¨åŠ å¯†æ¥è¾¾åˆ° Secrecyï¼Œç”¨ MAC æ¥è¾¾åˆ° integrityã€‚

<img src="D:\Files\Learning Materials\Y4\Semester-2\CAN304\MD Picture\W3 Secure communications.png" alt="W3 Secure communications" style="zoom:50%;" />

ä¸Šå›¾ä¸­ï¼Œå‘é€è€…ç”¨ k1 åŠ å¯†æ¶ˆæ¯ï¼Œç”¨ k2 ç”Ÿæˆ MAC tagï¼Œç„¶åæŠŠåŠ å¯†æ¶ˆæ¯å’Œ tag å‘ç»™æ¥æ”¶æ–¹ï¼›æ¥æ”¶æ–¹ç”¨ k1 è§£å¯†æ¶ˆæ¯ï¼Œç”¨ k2 æ¥éªŒè¯æ¶ˆæ¯æ˜¯å¦è¢«ä¿®æ”¹è¿‡ã€‚è¿™æ ·å°±è¾¾æˆäº†åŠ å¯†é€šè®¯ã€‚



ä¸è¿‡è¿™é‡Œå­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼šå‡å¦‚æˆ‘ä»¬å‘é€ä¸¤æ¬¡ç›¸åŒçš„ä¿¡æ¯ï¼Œå¯†æ–‡ä¼šä¸åŒï¼Œä½† tag ä¼šç›¸åŒ (MAC is deterministic)ï¼Œè¿™ä¼šæ³„éœ²ä¿¡æ¯ã€‚

ä¸è¿‡è¿™ä¸ªé—®é¢˜å¾ˆå¥½è§£å†³ï¼šæˆ‘ä»¬ä¸ç”Ÿæˆæ˜æ–‡çš„ MACï¼Œè€Œæ˜¯ç”Ÿæˆå¯†æ–‡çš„ MACï¼Œè¿™æ ·æ¯æ¬¡å¯†æ–‡ä¸åŒï¼Œtag ä¹Ÿä¸åŒã€‚è€Œæ¥æ”¶æ–¹æ”¶åˆ°æ¶ˆæ¯åï¼Œéœ€è¦å…ˆç”¨å¯†æ–‡éªŒè¯ï¼Œå†è§£å¯†ã€‚

<img src="D:\Files\Learning Materials\Y4\Semester-2\CAN304\MD Picture\W3 Encrypt then authenticate.png" alt="W3 Encrypt then authenticate" style="zoom: 50%;" />



**Attacks in Secure sessions**

Replay attackï¼šsender ç»™ receiver å‘é€ä¸¤æ¡æ¶ˆæ¯ (c1, t1) å’Œ (c2, c2)ï¼›attacker æˆªç•™ç¬¬äºŒæ¡æ¶ˆæ¯ (c2, c2)ï¼Œå¹¶ä¼ªè£…æˆ sender å†å‘ä¸€é  (c1, t1)ã€‚

Re-ordering attackï¼šsender ç»™ receiver å‘é€ä¸¤æ¡æ¶ˆæ¯ (c1, t1) å’Œ (c2, c2)ï¼›attacker æˆªç•™ä¸¤æ¡æ¶ˆæ¯ï¼Œä¼ªè£…æˆ sender æ›´æ”¹é¡ºåºåå‘é€ä¸¤æ¡æ¶ˆæ¯ã€‚

Solutionï¼šä½¿ç”¨ counters å’Œ identities æ¥é˜²æ­¢è¿™äº›æ”»å‡» (ä»¥åŠå…¶ä»–æ”»å‡»)ã€‚å³å‘é€æ¶ˆæ¯æ—¶å¸¦ä¸Šè‡ªå·±çš„æ ‡è¯†å’Œæ¶ˆæ¯çš„æ•°é‡ï¼Œå¦‚ (â€ğµğ‘œğ‘â€|$ğ‘š_1$|1) æˆ– (â€Aliceâ€|$ğ‘š_5$|5)ã€‚



## Hash functions and applications

### Hash functions

(Cryptographic) hash functionï¼š(åŠ å¯†å“ˆå¸Œå‡½æ•°) å°†ä»»æ„é•¿åº¦çš„è¾“å…¥æ˜ å°„åˆ°å›ºå®šé•¿åº¦çš„ï¼Œç®€çŸ­çš„æ‘˜è¦ (digest)ã€‚

<img src="D:\Files\Learning Materials\Y4\Semester-2\CAN304\MD Picture\W3 Hash functions.png" alt="W3 Hash functions" style="zoom: 50%;" />

å¯ä»¥å®šä¹‰ keyed or unkeyed hash functions (å³ï¼Œä½¿ç”¨å¯†é’¥ç”Ÿæˆï¼Œå’Œä¸ä½¿ç”¨å¯†é’¥ç”Ÿæˆ)ã€‚



**Properties of cryptographic hash functions**

Let ğ»: {0,1}^*^ â†’ {0,1}^n^ be a hash function (ä»»æ„é•¿åº¦æ˜ å°„åˆ°å›ºå®šé•¿åº¦)ã€‚Cryptographic hash functions æœ‰ä¸‰ä¸ªæ€§è´¨ï¼š

* Preimage resistance

  æˆ‘ä»¬å¯ä»¥æŠŠä»»æ„çš„ä¿¡æ¯ M æ˜ å°„ä¸º hash value hï¼ŒM ä¾¿æ˜¯ h çš„preimageã€‚æˆ‘ä»¬åªèƒ½é€šè¿‡ M è®¡ç®—å‡º hï¼Œæ— æ³•é€šè¿‡ h è®¡ç®—å‡º M (One-way function)

* Second preimage resistance

  ç»™å®šä¸€ä¸ª xï¼Œæˆ‘ä»¬æ— æ³•æ‰¾åˆ°ä¸€ä¸ª ğ‘¥â€²  (ğ‘¥â€² â‰  ğ‘¥) æ¥ä½¿å¾— ğ»(ğ‘¥) = ğ»(ğ‘¥â€²)ï¼Œè¿™ä¸ªä¹Ÿå« weak collision resistantã€‚

* Collision resistance

  collision æ˜¯æŒ‡ç»™å®šä¸¤ä¸ªä¸åŒçš„è¾“å…¥ ğ‘¥ å’Œ ğ‘¥â€²ï¼Œå®ƒä»¬çš„è¾“å‡º ğ»(ğ‘¥) = ğ»(ğ‘¥â€²)ã€‚å¦‚æœæˆ‘ä»¬æ— æ³•æ‰¾åˆ° H çš„ collisionï¼Œé‚£ä¹ˆ H æ˜¯ collision-resistance çš„ï¼Œè¿™ä¹Ÿå« strong collision resistanceã€‚

 weak collision resistant å’Œ strong collision resistance çš„åŒºåˆ«ï¼šweak collision resistant æ˜¯ç»™å®šä¸€ä¸ª xï¼Œæ‰¾åˆ° ğ‘¥â€²ï¼›strong collision resistance æ˜¯è¦æ‰¾åˆ°ä¸€å¯¹ ğ‘¥ å’Œ ğ‘¥â€²ã€‚



**Generic hash-function attacks**

å† hash function ä¸­ï¼Œè¾“å…¥æ˜¯ä»»æ„é•¿åº¦çš„ï¼Œä½†è¾“å‡ºæ˜¯å›ºå®šé•¿åº¦çš„ - {0, 1}^n^ï¼Œå³ 2^n^ã€‚å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬å¯¹ 2^n^+1 ä¸ªä¿¡æ¯è¿›è¡Œ hash functionï¼Œåˆ™ 100% ä¿è¯è‡³å°‘æœ‰ä¸€ä¸ª collisionã€‚

ä¸è¿‡ï¼Œå¦‚æœæˆ‘ä»¬å¸Œæœ›æœ‰ 50% çš„æ¦‚ç‡æ‰¾åˆ°ä¸€ä¸ª collisionï¼Œéœ€è¦æœ‰å¤šå°‘ä¸ªä¿¡æ¯å‘¢ï¼Ÿâ€” 2^n/2^ ä¸ªã€‚



**Hash functions in practice**

* MD5
  * 128-bit output length
  * should no longer be used
* SHA-1
  * 160-bit output length
  * ç†è®ºåˆ†æè¡¨æ˜å®ƒå­˜åœ¨ä¸€äº›å¼±ç‚¹
  * å¾ˆå¸¸è§ï¼Œä½†æœ‰è¢« SHA-2 ä»£æ›¿çš„è¶‹åŠ¿
* SHA-2
  * 224-bit, 256-bit, 384-bit or 512-bit output lengths
  * æ²¡æœ‰å·²çŸ¥çš„é‡å¤§å¼±ç‚¹
* SHA-3/Keccak
  * ä¸ SHA family æˆªç„¶ä¸åŒçš„è®¾è®¡
  * Supports 224, 256, 384, and 512-bit outputs



### HMAC

ç°åœ¨æˆ‘ä»¬ä½¿ç”¨ hash function æ¥è¿›è¡ŒéªŒè¯ï¼šsender è®¡ç®— message m çš„ hash value hï¼Œç„¶åæŠŠ m å’Œ h å‘ç»™ receiverï¼›receiver å†è®¡ç®— m çš„ hash valueï¼Œå¹¶ä¸ h ä½œæ¯”è¾ƒï¼Œå¦‚æœä¸€è‡´ï¼Œåˆ™æ¶ˆæ¯æ²¡æœ‰è¢«ç¯¡æ”¹ã€‚



æˆ‘ä»¬å¯ä»¥æŠŠ Hash function å’Œ block cipher-based MAC è¿™ä¸¤ä¸ª crypto primitives ç»“åˆèµ·æ¥ï¼š

<img src="D:\Files\Learning Materials\Y4\Semester-2\CAN304\MD Picture\W3 HMAC.png" alt="W3 HMAC" style="zoom: 50%;" />



HMACï¼š

![W3 HMAC construction](D:\Files\Learning Materials\Y4\Semester-2\CAN304\MD Picture\W3 HMAC construction.png)

k æ˜¯å¯†é’¥ï¼Œm æ˜¯ messageï¼ŒH æ˜¯ hash functionï¼ŒII ä»£è¡¨ cancatã€‚



### Merkle tree

Hash function çš„å¦ä¸€é¡¹åº”ç”¨æ˜¯ Merkle treeã€‚

$h = MHT(x_1, x_2, ..., x_n)$



**Construction**

![W3 Construction of Merkle tree](D:\Files\Learning Materials\Y4\Semester-2\CAN304\MD Picture\W3 Construction of Merkle tree.png)

å‡å¦‚æˆ‘ä»¬æœ‰ 8 ä¸ªæ–‡ä»¶ï¼Œæˆ‘ä»¬å°†æ–‡ä»¶ä¸¤ä¸¤åˆå¹¶æ±‚ hash valueï¼Œå°†ç»“æœå†ä¸¤ä¸¤åˆå¹¶æ±‚ hash valueâ€¦â€¦æœ€åçš„ç»“æœå°±æ˜¯ Merkle tree çš„è¾“å‡º (leaf èŠ‚ç‚¹æ˜¯ æ–‡ä»¶ï¼Œroot èŠ‚ç‚¹æ˜¯è¾“å‡º)ã€‚



**Merkle proof**

æˆ‘ä»¬æŠŠ 8 ä¸ªæ–‡ä»¶å’Œ Merkle tree ä¼ åˆ°ç½‘ç›˜é‡Œï¼Œç°åœ¨æˆ‘ä»¬æƒ³éªŒè¯ file 3 æœ‰æ²¡æœ‰è¢«æ›´æ”¹ã€‚

æˆ‘ä»¬åªéœ€è¦ä¸‹è½½ file 3 $f_3, \ h_4, \ h_{1, 2}, \ h_{5, 8}$ï¼Œå°±å¯ä»¥éªŒè¯ integrityã€‚

![W3 Merkle proof](D:\Files\Learning Materials\Y4\Semester-2\CAN304\MD Picture\W3 Merkle proof.png)

æˆ‘ä»¬æ ¹æ® $f_3$ å’Œ $h_4$ ç®—å‡º $h_{3,4}$ï¼Œç„¶åæ ¹æ® $h_{3,4}$ å’Œ $h_{1,2}$ ç®—å‡º $h_{1,4}$ï¼Œæœ€åæ ¹æ® $h_{1,4}$ å’Œ  $h_{5,8}$ ç®—å‡º $h_{1,8}$ã€‚å¦‚æœ $h_{1,8}$ å’Œä¹‹å‰çš„ä¸€æ ·ï¼Œé‚£ä¹ˆ file 3 å°±æ²¡æœ‰è¢«æ›´æ”¹ã€‚



### Bitcoin

æ¯”ç‰¹å¸æ˜¯ hash function çš„å¦ä¸€ä¸ªåº”ç”¨ï¼Œå®ƒæ˜¯ç¬¬ä¸€ä¸ªä¹Ÿæ˜¯æœ€å¹¿æ³›è®¤å¯çš„åŠ å¯†è´§å¸ã€‚

